> https://juejin.cn/post/6844903545016156174
# 资源加载过程
当浏览器截获到一个页面请求后，将会按照顺序做如下图所示的4件事：
1. 首先会将所有需要加载的资源进行分类。
2. 然后根据浏览器相关的安全策略，来决定资源的加载权限。
3. 接着对各个资源的加载优先级进行计算和排序。
4. 最后一步，根据加载优先级顺序来加载资源。

## 第一步：资源分类
chrome浏览器会将资源分为14类
## 第二步：资源安全策略检查（CSP）
开发者通过配置，来告诉浏览器各类外部资源的加载和执行限制，来提高网页的安全性。
## 第三步：资源优先级计算
资源的优先级被分为5级：
+ **网络层面**，5级分别为：Highest、Medium、Low、Lowest、Idle;
+ **浏览器内核**，5级分别为：VeryHigh、High、Medium、Low、VeryLow;
+ **用户端控制台显示**，5级分别为：Highest、High、Medium、Low、Lowest；

### 以浏览器内核为例：

1. 第一步，根据资源的类型来设定默认优先级。 对于每一类资源浏览器都有一个默认的加载优先级规则：
   + html、css、font类资源；
   + preload资源（通过<link rel=“preload">标签预加载）、script、xhr请求；
   +  图片、语音、视频；
   +  prefetch预读取的资源。
2. 第二步，根据一定的实际规则，对优先级进行调整

初始优先级设置好以后，浏览器会根据资源的实际属性和位于文档中的位置等方面，对优先级进行调整，来确定出最终的加载优先级顺序。

对于几个常见资源类型的调整规则如下：

+ 对于XHR请求资源：
  + 将同步XHR请求的优先级调整为最高。
  + XHR请求可以分为同步请求和异步请求，浏览器会把同步请求的优先级提升到最高级，以便尽早获取数据、加快页面的显示。
+ 对于图片资源：
  + 会根据图片是否在可见视图之内来改变优先级。
  + 图片资源的默认优先级为Low。
  + 现代浏览器为了提高用户首屏的体验，在渲染时会计算图片资源是否在首屏可见视图之内，在的话，会将这部分视口可见图片(Image in viewport)资源的优先级提升为High。
+ 对于脚本资源：
  + 浏览器会将根据脚本所处的位置和属性标签分为三类，分别设置优先级。
  + 第一步：对于添加了defer/async属性标签的脚本的优先级会全部降为Low。
  + 第二步：对于没有添加defer/async的脚本，根据该脚本在文档中的位置是在浏览器展示的第一张图片之前还是之后，又可分为两类。
    + 在之前的(标记early**)它会被定为High优先级，
    + 在之后的(标记late**)会被设置为Medium优先级。

## 第四步：按照上面计算的安全策略和优先级来加载或阻塞资源

# 资源加载优化
## 一、合理采用缓存机制
### 常见缓存类型
1. 浏览器缓存
2. CDN缓存
3. HTML5 Application Cache
4. PWA
5. LocalStorage
6.
## 二、利用Preload和Prefetch
### DNS 预解析 DNS-Prefetch
通过 DNS 预解析来告诉浏览器未来我们可能从某个特定的 URL 获取资源，当浏览器真正使用到该域中的某个资源时就可以尽快地完成 DNS 解析.多在使用第三方资源时使用。

### 预连接 Preconnect
完成 DNS 预解析同时还将进行 TCP 握手和建立传输层协议。

### 预渲染 Prerender
预先加载文档的所有资源，类似于在一个隐藏的 tab 页中打开了某个链接 – 将下载所有资源、创建 DOM 结构、完成页面布局、应用 CSS 样式和执行 JavaScript 脚本等。

### preload：预加载
主动通知浏览器获取本页的关键资源，只是预加载，加载资源后并不会执行

### 预获取 Prefetching
如果我们确定某个资源将来一定会被使用到，我们可以让浏览器预先请求该资源并放入浏览器缓存中。例如，一个图片和脚本或任何可以被浏览器缓存的资源：
```html
  <link rel="prefetch" href="image.png">
```
+ 与 DNS 预解析不同，预获取真正请求并下载了资源，并储存在缓存中。
+ 但预获取还依赖于一些条件，某些预获取可能会被浏览器忽略，例如从一个非常缓慢的网络中获取一个庞大的字体文件。
+ 并且，Firefox 只会在浏览器闲置时进行资源预获取。


### preload VS prefetch
+ preload是声明式的 fetch，可以强制浏览器请求资源，同时不阻塞文档 onload 事件，是对浏览器指示预先请求当前页需要的资源（关键的脚本，字体，主要图片）。
+ prefetch提示浏览器这个资源将来可能需要，但是把决定是否和什么时间加载这个资源的决定权交给浏览器。prefetch 应用场景稍微有些不同 —— 用户将来可能在其他部分（比如视图或页面）使用到的资源。
+ 优先级： preload > prefetch。
+ 兼容性：兼容性二者都不是很高。
+ preload最基本的使用方式是提前加载较晚发现的资源例(如web字体）

## 三、按需加载
将不影响首屏的资源和当前屏幕资源不必的资源放到用户需求时才加载，能够大大提高重要资源的显现速度和下降整体流量。


## 四、图片优化
+ (1) 适时压缩图片

+ (2) 选择合适的图片格式

+ (3) 选择适当的图片宽度尺寸
  + 通过媒体查询来加载不同尺寸的图片
  + Img的srcset和sizes的方法
  + picture标签实现
## 五、字体优化
对于已知页面依赖字体内容的情况下，可以使用字蛛（https://github.com/aui/font-spider）进行字体包压缩，

字蛛通过分析本地 CSS 与 HTML 文件获取 WebFont 中没有使用的字符，并将这些字符数据从字体中删除以实现压缩，同时生成跨浏览器使用的格式。